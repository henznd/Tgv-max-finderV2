<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Bot Strat√©gie - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header a {
            color: #3498db;
            text-decoration: none;
            font-size: 0.9em;
        }

        .main-content {
            padding: 30px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-running {
            background: #2ecc71;
            color: white;
        }

        .status-stopped {
            background: #95a5a6;
            color: white;
        }

        .logs-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            scroll-behavior: smooth;
        }

        .log-line {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
            word-wrap: break-word;
        }

        .log-event {
            background: rgba(102, 126, 234, 0.2);
            border-left: 3px solid #667eea;
            padding: 10px;
            margin-bottom: 10px;
        }

        .log-entry {
            background: rgba(46, 204, 113, 0.2);
            border-left: 3px solid #2ecc71;
        }

        .log-exit {
            background: rgba(231, 76, 60, 0.2);
            border-left: 3px solid #e74c3c;
        }

        .log-error {
            background: rgba(231, 76, 60, 0.2);
            border-left: 3px solid #e74c3c;
            color: #ff6b6b;
        }

        .log-info {
            color: #95a5a6;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .alert-success {
            background: #2ecc71;
        }

        .alert-error {
            background: #e74c3c;
        }

        .alert-info {
            background: #3498db;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Bot Strat√©gie d'Arbitrage</h1>
            <p>Interface de contr√¥le et monitoring</p>
            <a href="/">‚Üê Retour au bot manuel</a>
        </div>

        <div class="main-content">
            <!-- Configuration -->
            <div class="panel">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label>Token:</label>
                        <select id="token">
                            <option value="BTC" selected>BTC</option>
                            <option value="ETH">ETH</option>
                            <option value="SOL">SOL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Marge ($):</label>
                        <input type="number" id="margin" value="20" min="1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Levier:</label>
                        <input type="number" id="leverage" value="50" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Entry Z-score:</label>
                        <input type="number" id="entry_z" value="1.0" min="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Exit Z-score:</label>
                        <input type="number" id="exit_z" value="0.5" min="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Stop Z-score:</label>
                        <input type="number" id="stop_z" value="4.0" min="0.1" step="0.1">
                    </div>
                </div>
            </div>

            <!-- Contr√¥les -->
            <div class="panel">
                <h2>üéÆ Contr√¥les</h2>
                <div style="margin-bottom: 20px;">
                    <strong>Statut:</strong> 
                    <span id="bot-status" class="status-badge status-stopped">Arr√™t√©</span>
                </div>

                <button class="btn btn-primary" id="btn-launch" onclick="launchBot()">üöÄ Lancer le bot</button>
                <button class="btn btn-danger" id="btn-stop" onclick="stopBot()" disabled>üõë Arr√™ter le bot</button>
                <button class="btn" onclick="resetSession()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: 10px;">üîÑ Reset Session</button>
            </div>

            <!-- Statistiques -->
            <div class="panel">
                <h2>üìä Statistiques</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                        <h3 style="color: rgba(255,255,255,0.95); font-weight: 600;">Z-score actuel</h3>
                        <div class="value" id="stat-zscore" style="color: white; font-size: 2.5em; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Positions ouvertes</h3>
                        <div class="value" id="stat-positions">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Trades ex√©cut√©s</h3>
                        <div class="value" id="stat-trades">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Entr√©es</h3>
                        <div class="value" id="stat-entries">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Sorties</h3>
                        <div class="value" id="stat-exits">0</div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="margin: 0;">üìã √âv√©nements importants</h2>
                    <button class="btn btn-primary" onclick="scrollLogsToBottom()" style="padding: 8px 16px; font-size: 0.9em;">‚¨áÔ∏è Aller en bas</button>
                </div>
                <div class="logs-container" id="logs-container">
                    <div class="log-line log-info">En attente des √©v√©nements...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logsInterval = null;
        let stats = {
            positions: 0,
            trades: 0,
            entries: 0,
            exits: 0
        };

        // Fonction pour afficher une alerte
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        // Lancer le bot
        async function launchBot() {
            const token = document.getElementById('token').value;
            const margin = parseFloat(document.getElementById('margin').value);
            const leverage = parseInt(document.getElementById('leverage').value);
            const entry_z = parseFloat(document.getElementById('entry_z').value);
            const exit_z = parseFloat(document.getElementById('exit_z').value);
            const stop_z = parseFloat(document.getElementById('stop_z').value);

            if (!confirm(`Lancer le bot avec ces param√®tres?\nToken: ${token}\nMarge: $${margin}\nLevier: ${leverage}x\nEntry Z: ${entry_z}\nExit Z: ${exit_z}\nStop Z: ${stop_z}`)) {
                return;
            }

            try {
                const response = await fetch('/api/launch-strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token,
                        margin,
                        leverage,
                        entry_z,
                        exit_z,
                        stop_z
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('Bot lanc√© avec succ√®s!', 'success');
                    checkStatus();
                    startLogsPolling();
                } else {
                    showAlert('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
                }
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        }

        // Arr√™ter le bot
        async function stopBot() {
            if (!confirm('Arr√™ter le bot strat√©gie?')) {
                return;
            }

            try {
                const response = await fetch('/api/stop-strategy', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('Arr√™t du bot demand√©', 'info');
                    checkStatus();
                    stopLogsPolling();
                } else {
                    showAlert('Erreur: ' + (result.error || 'Erreur inconnue'), 'error');
                }
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        }

        // R√©initialiser la session
        async function resetSession() {
            if (!confirm('‚ö†Ô∏è Voulez-vous vraiment r√©initialiser la session ?\n\nCela va :\n‚úÖ Archiver les logs actuels dans logs/archives/\n‚úÖ R√©initialiser les statistiques √† 0\n‚úÖ Effacer l\'affichage des logs\n\n‚ö†Ô∏è Le bot continuera de tourner si il est actif.')) {
                return;
            }

            try {
                const response = await fetch('/api/strategy/reset', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    // R√©initialiser les stats localement
                    document.getElementById('stat-positions').textContent = '0';
                    document.getElementById('stat-trades').textContent = '0';
                    document.getElementById('stat-entries').textContent = '0';
                    document.getElementById('stat-exits').textContent = '0';
                    document.getElementById('stat-zscore').textContent = '-';
                    document.getElementById('stat-zscore').style.color = 'white';
                    
                    // Effacer compl√®tement les logs affich√©s
                    const logsContainer = document.getElementById('logs');
                    logsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666; font-size: 1.3em; line-height: 1.8;">' +
                        '‚ú® <strong>Session r√©initialis√©e avec succ√®s</strong> ‚ú®<br>' +
                        'üì¶ ' + (data.archived_logs || 0) + ' fichier(s) archiv√©(s)<br>' +
                        'üîÑ En attente de nouveaux √©v√©nements...<br>' +
                        '<small style="color: #999; font-size: 0.9em; margin-top: 10px; display: block;">Les anciens logs sont sauvegard√©s dans logs/archives/</small>' +
                        '</div>';
                    
                    // R√©initialiser compl√®tement les timestamps et l'historique des logs
                    lastLogTimestamp = null;
                    displayedLogs.clear();
                    
                    // Afficher une notification de succ√®s
                    showAlert(`‚úÖ Session r√©initialis√©e ! ${data.archived_logs || 0} fichiers archiv√©s.`, 'success');
                    
                    console.log('‚úÖ Reset effectu√©: stats r√©initialis√©es, logs effac√©s, timestamps r√©initialis√©s');
                } else {
                    showAlert('‚ùå Erreur lors de la r√©initialisation: ' + (data.error || 'Erreur inconnue'), 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors de la r√©initialisation', 'error');
            }
        }

        // V√©rifier le statut
        async function checkStatus() {
            try {
                const response = await fetch('/api/status-strategy');
                const status = await response.json();
                
                const statusBadge = document.getElementById('bot-status');
                const btnLaunch = document.getElementById('btn-launch');
                const btnStop = document.getElementById('btn-stop');
                
                if (status.running) {
                    statusBadge.textContent = 'En cours d\'ex√©cution';
                    statusBadge.className = 'status-badge status-running';
                    btnLaunch.disabled = true;
                    btnStop.disabled = false;
                } else {
                    statusBadge.textContent = 'Arr√™t√©';
                    statusBadge.className = 'status-badge status-stopped';
                    btnLaunch.disabled = false;
                    btnStop.disabled = true;
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification du statut:', error);
            }
        }

        // R√©cup√©rer les logs filtr√©s
        let lastLogTimestamp = null;
        let displayedLogs = new Set(); // Pour √©viter les doublons
        
        async function fetchLogs() {
            try {
                // Ajouter un timestamp pour √©viter le cache
                const response = await fetch('/api/logs-strategy?t=' + Date.now());
                if (!response.ok) {
                    return;
                }
                const data = await response.json();
                
                // Mettre √† jour les statistiques depuis le serveur
                if (data.stats) {
                    stats.positions = data.stats.positions || 0;
                    stats.trades = data.stats.trades || 0;
                    stats.entries = data.stats.entries || 0;
                    stats.exits = data.stats.exits || 0;
                    updateStats();
                }
                
                // Mettre √† jour le Z-score
                if (data.z_score !== null && data.z_score !== undefined) {
                    const zScoreElement = document.getElementById('stat-zscore');
                    const zScoreValue = parseFloat(data.z_score);
                    zScoreElement.textContent = zScoreValue.toFixed(2);
                    
                    // Colorer selon la valeur du Z-score (sur fond d√©grad√©, utiliser des couleurs claires)
                    if (Math.abs(zScoreValue) >= 1.0) {
                        zScoreElement.style.color = '#ffeb3b'; // Jaune vif pour valeurs √©lev√©es (visible sur fond violet)
                    } else if (Math.abs(zScoreValue) >= 0.5) {
                        zScoreElement.style.color = '#ff9800'; // Orange vif pour valeurs moyennes
                    } else {
                        zScoreElement.style.color = '#4caf50'; // Vert clair pour valeurs faibles
                    }
                } else {
                    document.getElementById('stat-zscore').textContent = '-';
                    document.getElementById('stat-zscore').style.color = 'white';
                }
                
                if (data.logs && data.logs.length > 0) {
                    const container = document.getElementById('logs-container');
                    
                    // V√©rifier si l'utilisateur est en bas AVANT toute modification
                    const scrollTop = container.scrollTop;
                    const scrollHeight = container.scrollHeight;
                    const clientHeight = container.clientHeight;
                    const isAtBottom = Math.abs(scrollHeight - scrollTop - clientHeight) < 5;
                    
                    // Filtrer les logs pour ne garder que les nouveaux (bas√© sur le timestamp)
                    const newLogs = [];
                    for (const log of data.logs) {
                        // Extraire le timestamp du log (format: 2025-11-10 00:48:49)
                        const timestampMatch = log.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
                        if (timestampMatch) {
                            const logTimestamp = timestampMatch[1];
                            // Si c'est un nouveau log (apr√®s le dernier timestamp vu)
                            if (!lastLogTimestamp || logTimestamp > lastLogTimestamp || !displayedLogs.has(log)) {
                                newLogs.push(log);
                                displayedLogs.add(log);
                            }
                        } else {
                            // Si pas de timestamp, ajouter quand m√™me (pour les logs sans timestamp)
                            if (!displayedLogs.has(log)) {
                                newLogs.push(log);
                                displayedLogs.add(log);
                            }
                        }
                    }
                    
                    // Mettre √† jour le dernier timestamp
                    if (data.logs.length > 0) {
                        const lastLog = data.logs[data.logs.length - 1];
                        const timestampMatch = lastLog.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
                        if (timestampMatch) {
                            lastLogTimestamp = timestampMatch[1];
                        }
                    }
                    
                    // Si pas de nouveaux logs, ne rien faire
                    if (newLogs.length === 0) {
                        return;
                    }
                    
                    // Ajouter seulement les nouveaux logs
                    newLogs.forEach(log => {
                        const logLine = document.createElement('div');
                        logLine.className = 'log-line';
                        
                        // D√©terminer le type de log
                        if (log.includes('üöÄ') || log.includes('D√©marrage') || log.includes('BOT D\'ARBITRAGE')) {
                            logLine.className += ' log-event';
                        } else if (log.includes('üéØ') || log.includes('SIGNAL D\'ENTR√âE') || log.includes('TRADES EX√âCUT√âS')) {
                            logLine.className += ' log-entry';
                        } else if (log.includes('üìâ') || log.includes('POSITION FERM√âE') || log.includes('Sortie') || log.includes('Signal de sortie d√©tect√©') || log.includes('Signal de sortie en validation')) {
                            logLine.className += ' log-exit';
                        } else if (log.includes('‚ùå') || log.includes('ERROR') || log.includes('√âCHEC')) {
                            logLine.className += ' log-error';
                        } else if (log.includes('üëÅÔ∏è') || log.includes('Surveillance')) {
                            logLine.className += ' log-info';
                        } else {
                            logLine.className += ' log-info';
                        }
                        
                        logLine.textContent = log;
                        container.appendChild(logLine);
                    });
                    
                    // Limiter √† 150 logs maximum dans le conteneur
                    // MAIS seulement si l'utilisateur est en bas (pour ne pas perturber la lecture)
                    const allLogLines = container.querySelectorAll('.log-line');
                    if (isAtBottom && allLogLines.length > 150) {
                        const toRemove = allLogLines.length - 150;
                        for (let i = 0; i < toRemove; i++) {
                            const removedLog = allLogLines[i].textContent;
                            displayedLogs.delete(removedLog);
                            allLogLines[i].remove();
                        }
                    }
                    
                    // D√âSACTIVER le scroll automatique pour √©viter les bugs
                    // L'utilisateur peut scroller manuellement
                    // On ne touche JAMAIS au scroll automatiquement
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des logs:', error);
            }
        }

        // Mettre √† jour les statistiques
        function updateStats() {
            document.getElementById('stat-positions').textContent = stats.positions;
            document.getElementById('stat-trades').textContent = stats.trades;
            document.getElementById('stat-entries').textContent = stats.entries;
            document.getElementById('stat-exits').textContent = stats.exits;
        }

        // D√©marrer le polling des logs
        function startLogsPolling() {
            if (logsInterval) {
                clearInterval(logsInterval);
            }
            // R√©initialiser les variables de suivi
            lastLogTimestamp = null;
            displayedLogs.clear();
            // Charger les logs initiaux
            fetchLogs();
            // Puis continuer toutes les secondes pour une mise √† jour en temps r√©el du Z-score
            logsInterval = setInterval(fetchLogs, 1000);
        }

        // Arr√™ter le polling des logs
        function stopLogsPolling() {
            if (logsInterval) {
                clearInterval(logsInterval);
                logsInterval = null;
            }
            // R√©initialiser les variables de suivi
            lastLogTimestamp = null;
            displayedLogs.clear();
        }
        
        // Fonction pour scroller en bas des logs
        function scrollLogsToBottom() {
            const container = document.getElementById('logs-container');
            container.scrollTop = container.scrollHeight;
        }

        // Initialisation
        checkStatus();
        setInterval(checkStatus, 5000); // V√©rifier le statut toutes les 5 secondes
        
        // D√©marrer le polling des logs automatiquement
        startLogsPolling();
    </script>
</body>
</html>

